（本章开始不再写大部分专有名词英文全拼）
# 5.1 概述
转发表和流表如何计算、维护和安装：
- 每路由器控制：每台路由器运行路由选择算法，包含转发和路由选择功能，有路由选择组件和其他路由器的路由选择组件通信，来计算转发表的值。![[Pasted image 20231015170738.png]] 
- 逻辑集中式控制![[Pasted image 20231015170744.png]] 控制器通过协议与每台路由器中的一个控制代理（CA）交互，来配置转发表。CA不直接互相交互，也不主动算转发表。
# 5.2 路由选择算法
路由选择算法的目的是从发送方到接收方的过程中确定一条通过路由器网络的好的路径（等价于路由）。好通常是最低开销，同时还关心策略。
通过图来研究。==图==G=（N,E）是一个N个节点和E条边的集合。网络层，节点表示路由器，边表示物理链路：![[Pasted image 20231015180517.png]] 
- 边的开销能反映对应链路的物理长度，链路速度，相关金钱开销。研究时认为链路开销给定。如果边有相同开销，则最低开销路径也是最短路径。
- 一些相关讲解：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=262&selection=470,0,786,6|计算机网络：自顶向下方法（原书第七版）, page 262]] 
- 根据集中式和分散式来划分两种算法：
	- ==集中式路由选择算法==：需要有关于连通性和链路开销的完整信息，称为==链路状态（Link State，LS）算法==。可在逻辑集中控制器或者每台路由器的路由选择组件重复计算。
	- ==分散式路由选择算法==：没有节点拥有所有网络链路开销的完整信息。通过迭代计算及与相邻节点信息交换逐渐算出最低开销路径。有==距离向量（Distance-Vector，DV）==算法。
- 根据静态和动态来划分算法：
	- ==静态路由选择算法==：通常人工调整。
	- ==动态路由选择算法==：响应网络流量负载或拓扑变化。容易受影响。
- 根据负载敏感还是负载迟钝来划分：
	- ==负载敏感算法==：开销动态变化，反映拥塞水平。
	- ==负载迟钝算法==：当今因特网都是负载迟钝的。
## 5.2.1 链路状态路由选择算法（LS算法）
LS算法，是通过让每个节点向网络中所有其他节点广播链路状态分组（包含链路标识和开销）来收集到所有链路开销。实践中（比如OSPF路由选择协议），这个过程可由==链路状态广播（link state broadcast）==算法完成。
一种叫做Dijkstra的LS算法：![[Pasted image 20231015183732.png]]
讲解：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=265&selection=6,0,320,1|计算机网络：自顶向下方法（原书第七版）, page 265]] 
- 通过对每个目的节点存放从u到目的地的最低开销路径上的下一条节点，在一个节点中的转发表就能根据这个信息来构建：![[Pasted image 20231015185013.png]] 设除了源节点之外的节点数为n，则迭代过程需要搜寻节点总数为n（n+1）/2（每次迭代N'集合都增多1个节点）。复杂性是O（n<sup>2</sup>）。算法更复杂的实现是通过堆结构，把时间从线性变为对数时间得到第九行最小值。
- 由于拥塞，开销动态变化，因此导致振荡：![[Pasted image 20231015200205.png]] 为了避免这种情况，要确保不是所有路由器同时运行LS算法。路由器会自同步，因此要让每台路由器发送链路通告的时间随机化。
## 5.2.2 距离向量路由选择算法
DV算法是迭代、异步、分布式算法。![[Pasted image 20231015201256.png]] x是源，y是目的，d是源到最低开销路径的开销。
解释：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=267&selection=89,0,172,4|计算机网络：自顶向下方法（原书第七版）, page 267]] 
每个节点一直向邻居发距离向量副本，每个节点收到距离向量就用这个方程更新：![[Pasted image 20231015202617.png]] 算法：![[Pasted image 20231015202655.png]] 决定转发表的是第14行的最小邻居v。
一个例子：![[Pasted image 20231015210242.png]] 最左侧一列表是初始==路由选择表==。
### 1. 距离向量算法：链路开销改变与链路故障
一个节点一旦检测到开销改变就发给邻居通知。没有改变的时候算法保持静止。
但是当链路开销增大的时候可能会出现问题，这个问题是最新迭代时的数据与上次迭代的数据一起算，可能导致min值不是最小的，比如这个：![[Pasted image 20231015211906.png]] ![[Pasted image 20231015211917.png]] 其中Dz（x）用的还是开销改变前的5。
此时遇到了==路由选择环路==。z要到x，需要到y，y又会导向z而不是x，分组不停在这条路上转。
y会算出到x的新的最低开销，通知给z，z收到的内容是y到x最低开销是6（这是基于错误的结果），x一直知道能以1开销到y，这次算出Dz（x）最低开销是7，改变了，所以再通知给y。
用类似方式，z和y一直传来传去，持续44次，直到y算出经过y的路径开销大于50为止。如果开销特别大呢？这种问题有时被称为==无穷计数==问题。
### 2. 距离向量算法：增加毒性逆转
刚才的问题可以通过==毒性逆转==技术避免。很简单：
- 如果z要从y到x，z会通告y，z到x的最小开销是无穷大（实际上z知道这个值是5）。只要经过y，就告诉y这个谎言（有时候是正确的）。
- 这个办法，只要涉及3个或更多节点的环路就无法用毒性逆转技术检测到。
### 3. LS与DV路由选择算法的比较
两者互补。
- DV算法只和邻居交谈，告诉邻居自己到全部节点的最低开销
- LS算法每个节点通过广播和所有其他节点通信，但只告诉直接相连链路的开销
区别：
- 报文复杂性：LS要发O（|N||E|）个报文。
- 收敛速度：LS是O（|N|<sup>2</sup>）算法，DV收敛较慢，而且会遇到路由选择环路，无穷计数问题。
- 健壮性：LS节点只算自己的转发表，某种意义上路由器是分离的，提供一定健壮性。DV会通告不正确的开销，1997年一个ISP一个故障路由器导致因特网大部分连接中断数小时。
# 5.3 因特网中自治系统内部的路由选择：OSPF
之前的算法把模型简单化了。有两个问题：
- 规模：数亿主机，路由选择信息需要巨大内存，更新信息开销也巨大，而且DV算法几乎无法收敛。
- 管理自治：ISP会希望按自己的方式运行和管理自己的路由器。
通过==自治系统（Autonomous System，AS）==解决。每个AS由相同管理控制下的路由器组成，通常是一个ISP的路由器和互连他们的链路构成。ISP也可能拆分为多个AS。一个AS由全局唯一的AS号（ASN）标识，由ICANN区域注册机构分配。
一个AS内运行的路由选择算法叫==自治系统内部路由选择协议==。
### 开放最短优先（OSPF）
OSPF路由选择和IS-IS被广泛用于AS内部网络选择。OSPF开源。
它使用洪泛链路状态信息和dijkstra最低开销路径算法（LS算法的一种），每台路由器都有AS的完整拓扑图，每条链路开销由网络管理员配置。权值实践原则：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=274&selection=115,0,119,4|计算机网络：自顶向下方法（原书第七版）, page 274]] 
优点：
- 安全。能鉴别路由器交换，只有受信路由器能参与一个AS内的OSPF协议。两种鉴别：简单的和MD5的。
- 多条相同开销的路径：允许开销相同的多条路径同时负载流量，避免只用其中单一的路径。
- 对单播与多播路由选择的综合支持：多播OSPF（MOSPF）拓展了OSPF。
- 支持在单个AS中的层次结构：一个AS里可以划分为多个区域，各运行各的OSPF。边界的一台或几台路由器负责为流向区域外的分组提供路由选择。一个AS只有一个OSPF主干区域，至少包含本AS所有区域边界路由器，为其他区域之间流量提供路由选择。
# 5.4 ISP之间的路由选择：BGP
跨多个AS时，需要==自治系统间路由选择协议==。因特网所有AS都运行同一个，叫==边界网关协议（Broder Gateway Protocl，BGP）==。
## 5.4.1 BGP的作用
BGP中，分组路由到CIDR化的前缀。因此路由器转发表有（x，I）形式的表，x是前缀，I是这个路由器接口之一的接口号。
- 从邻居AS获得前缀可达性信息：BGP允许每个子网向因特网其他部分通告自己的存在，BGP确保所有AS知道该子网。
- 确定到该前缀的“最好的”路由：路由器本地允许BGP路由选择过程，基于策略和上面的可达性信息确定最好的路由。
## 5.4.2 通告BGP路由信息
每个AS，每台路由器要么是==网关路由器==（AS边缘），要么是==内部路由器==（只连接AS内部）。
例子：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=275&selection=424,0,522,8|计算机网络：自顶向下方法（原书第七版）, page 275]] ![[Pasted image 20231015222228.png]] BGP中，每对路由通过179端口的半永久TCP连接交换路由选择信息。每条直接连接和通过该连接发送的BGP报文，称为==BGP连接==。跨越两个AS的BGP被称为==外部BGP（eBGP）==，相同AS两台路由器间的BGP会话叫==内部BGP（iBGP）==。![[Pasted image 20231015222519.png]] 传播可达性信息过程：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=276&selection=403,0,557,1|计算机网络：自顶向下方法（原书第七版）, page 276]] 
现实情况：好几条路：![[Pasted image 20231015222728.png]] 
## 5.4.3 确定最好的路由
路由器通过BGP通告前缀时，包括了一些==BGP属性==。BGP术语里，前缀及其属性称为==路由（route）==。两个属性AS-PATH和NEXT-HOP：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=277&selection=195,0,305,1|计算机网络：自顶向下方法（原书第七版）, page 277]] 
### 1. 热土豆路由选择：
：![[Pasted image 20231015223413.png]]
热土豆的核心思想是赶紧让分组丢出本AS，减小在自己AS中的开销，不考虑外部余下部分的开销。
### 2. 路由器选择算法：
BGP使用的是比热土豆复杂的算法。算法的输入是到某前缀所有路由的集合。若大于一条路由，就调用消除规则直到只剩下一条路由，然后执行。规则如下：
1. 路由被指派一个本地偏好值作为属性之一。策略取决于AS管理员。选择最高本地偏好值的路由。
2. 选中的路由都是相同最高本地偏好值的路由，在其中选择具有最短AS-PATH的路由。如果这个规则是路由选择的唯一规则，BGO用DV算法决定路径，距离用AS的跳数而不是路由器的跳数。（这使得这个算法不自私，而是优先查找有短AS路径的路由）
3. 如果2里选中的路由还有相同的AS-PATH长度，用热土豆选，也就是选最靠近NEXT-HOP的路由。
4. 如果还没选到最后一条，就用BGP标识符选择。
## 5.4.4 IP任播
BGP还被用来做==IP任播==服务，这个服务通常在DNS里。
服务的动机：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=279&selection=254,0,313,1|计算机网络：自顶向下方法（原书第七版）, page 279]] 
例子：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=279&selection=314,0,469,16|计算机网络：自顶向下方法（原书第七版）, page 279]] 
实际使用：用于将DNS请求指向最近的根DNS服务器。![[Pasted image 20231015224836.png]] 
## 5.4.5 路由选择策略
A、B、C是主干提供商网络，W、X、Y是ISP。X是多宿接入ISP。
X说谎，不说自己有通向任何其他目的地的路径：![[Pasted image 20231015225033.png]] 以此让X不转发B和C的流量。
向其他主干提供商网络通告会导致一些商业成本问题。经验法则：任何穿越某ISP主干网的流量必须是其源或目的位于该ISP的某个客户网络里。
## 5.4.6 拼装在一起：在因特网中呈现
本节是对许多协议和概念的结合的例子。[[计算机网络：自顶向下方法（原书第七版）.pdf#page=282&selection=37,0,664,1|计算机网络：自顶向下方法（原书第七版）, page 282]] 
# 5.5 SDN控制平面
SDN：Software defined network
继续使用SDN中的术语，把网络转发设备称为“分组交换机”（或者直接说为交换机，理解时带上分组二字。）
SDN体系结构：
- 基于流的转发：SDN控制的交换机的分组转发工作能基于运输层、网络层、链路层首部任意数量的首部字段值进行。传统只根据IP数据报。SDN控制平面工作是计算、管理和安装所有网络交换机中的流表项。
- 数据平面与控制平面分离：数据平面由网络交换机组成，控制平面由服务器以及决定和管理交换机流表的软件组成。
- 网络控制功能：位于数据平面交换机外部。控制平面由两个组件组成：一个SDN控制器和若干网络控制应用程序。![[Pasted image 20231016090802.png]] 
- 可编程的网络：通过网络控制应用程序，网络可编程。比如路由器的端到端路径算法，访问控制，负载均衡等等。
## 5.5.1 SDN控制平面：SDN控制器和SDN网络控制应用程序
SDN控制器的功能：
- 通信层：SDN控制器和受控网络设备之间的通信。双向。
- 网络范围状态管理层：控制平面作出控制决定，需要控制器具有主机、链路、交换机和其他控制设备的最新状态信息。控制平面终极目标是决定用于各种受控设备的流表。
- 对于网络控制应用程序层的接口：API允许网络控制应用程序在状态管理层之间读写网络状态和流表。
- ![[Pasted image 20231016092728.png]] 
- 控制器是逻辑集中的、实践中分布式服务器实现的，有一些分布式系统共同关注的特点。
## 5.5.2 OpenFlow协议
OpenFlow协议运行在SDN控制器和SDN控制的交换机以及其他实现OpenFlow API的设备之间。OpenFlow协议运行在TCP上，使用6653默认端口号。
从控制器到受控交换机流动的重要报文有：
![[Pasted image 20231016093251.png]] 从受控交换机到控制器流动的重要报文：![[Pasted image 20231016093235.png]] 
## 5.5.3 数据平面和交互平面交互的例子
![[Pasted image 20231016093609.png]] 
[[计算机网络：自顶向下方法（原书第七版）.pdf#page=287&selection=7,0,7,14|计算机网络：自顶向下方法（原书第七版）, page 287]] 
## 5.5.4 SDN的过去与未来
SDN控制器学习案例：OpenDaylight和ONOS控制器：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=288&selection=269,0,281,3|计算机网络：自顶向下方法（原书第七版）, page 288]] 
# 5.6 ICMP：因特网控制报文协议
ICMP被主机和路由器用来彼此沟通网络层信息。最典型用途是差错报告。
ICMP通常被认为是IP的一部分，但是从体系结构上是位于IP之上的，因为ICMP报文承载在IP分组里。![[Pasted image 20231016095011.png]] 
# 5.7 网络管理和SNMP
网络管理的详细定义：![[Pasted image 20231016095416.png]] 
## 5.7.1 网络管理框架
网络管理的关键组件：
![[Pasted image 20231016095458.png]] 
- 管理服务器：是应用程序，有人参与，发起控制网络行为的动作。
- 被管设备：被管理的网络中，包括它的软件。可以是主机、路由器、交换机、中间盒、调制解调器、温度计或其他联网设备。被管设备里有被管对象，是硬件的实际部分和用于软硬件的配置参数。
- 管理信息库：一个被管设备中的每个被管对象的关联信息
- 网络管理代理：被管设备中驻留，是一个进程，与管理服务器通信。
- 网络管理协议：允许管理服务器查询被管设备的状态，并通过代理间接在设备上采取行动。
## 5.7.2 简单网络管理协议
==简单网络管理协议版本2（SNMPv2）==是应用层协议。
用于在管理服务器和代理之间传递网络管理控制和信息报文。
- 请求响应模式：发请求，代理执行动作，然后回答。
- 陷阱报：非请求报文，通知异常情况。
- 7种报文：![[Pasted image 20231016100537.png]] 
- 一些解释：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=294&selection=17,0,55,1|计算机网络：自顶向下方法（原书第七版）, page 294]] 
# 5.8 小结
略。[[计算机网络：自顶向下方法（原书第七版）.pdf#page=295&selection=293,0,295,2|计算机网络：自顶向下方法（原书第七版）, page 295]] 