网络层能够被分解为两个相互作用的部分：数据平面和控制平面。
- 数据平面功能，即网络层中每台路由器的功能。涉及传统的IP转发和通用的转发，学习IPv4和IPv6协议及其寻址。
- 控制平面功能，即网络范围的逻辑。涉及路由选择算法，以及OSPF、BGP等路由选择协议。
- 传统上数据平面和控制平面被实现为一个整体，位于路由器中。==软件定义网络（Software-Defined Networking，SDN）==明确分离数据平面和控制平面。
# 4.1 网络层概述
- 路由器的数据平面主要作用是从输入链路向输出链路转发数据报，控制买票的主要作用是协调转发动作，使得数据报沿着源和目的主机之间的路由器路径最终进行端到端传送。
- 路由器没有应用层和运输层协议。
![[Pasted image 20231012225512.png]] 
## 4.1.1 转发和路由选择：数据平面和控制平面。
- ==转发（forwarding）==：数据平面实现的唯一功能。一个分组到达某个路由器的一条输入链路时，路由器必须将分组移动到适当的输出链路。有时也会阻挡，比如识别到恶意主机等。
- ==路由选择（routing）==：分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算路径的算法被称为==路由选择算法（routing algorithm）==。
- ==转发表（forwarding table）==
### 1. 控制平面：传统的方法
- 路由选择算法决定了插入该路由器转发表的内容。一台路由器的路由选择算法与其他路由器的路由选择算法通信，来计算出转发表的值。
### 2. 控制平面：SDN方法
远程控制器来计算并分发转发表。其与路由器交换包含转发表和其他路由选择信息的报文来通信。![[Pasted image 20231013234444.png]] 上图即==软件定义网络（Soft-ware-Defined Networking，SDN）==。控制器是用软件实现的。
## 4.1.2 网络服务模型
==网络服务模型（network service model）==定义了分组在发送与接收端系统之间的端到端运输特性。网络层可能包含的服务：
- 确保交付
- 具有时延上界的确保交付
- 有序分组交付
- 确保最小带宽
- 安全性
网络层提供了单一的服务，称为==尽力而为服务（best-effort service）==。
### 第四章概述
*转发*和*交换*被交替使用。
约定：*分组交换机*指的是一台通用分组交换设备，根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。某些分组交换机被称为==链路层交换机（link-layer switch）==，基于链路层帧中的字段值作出转发决定，因此被称为链路层设备。其他分组交换机被称为==路由器（router）==，基于网络层数据报中的首部字段值作出转发决定，路由器因此是网络层设备。
# 4.2 路由器工作原理
路由器体系结构：![[Pasted image 20231013235446.png]]
- ==输入端口（input port）==：
1. 在路由器中执行终结入物理链路的物理层功能。
2. 与位于入链路远端的数据链路层交互来执行数据链路层功能。
3. 通过查询转发表决定路由器的输出端口。
- 交换结构：将路由器的输入端口连接到它的输出端口。它是一个路由器中的网络。
- 输出端口：存储从交换结构接收的分组，通过必要的链路层和物理层功能在输出链路上传输这些分组。
- 路由选择处理器：执行控制平面功能。在传统路由器执行路由选择协议，在SDN路由器负责与远端控制器通信，目的是接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项。此外，还执行网络管理功能。
输入端口、输出端口和交换结构几乎总是用硬件实现，因为软件执行的速度无法支撑大吞吐量下的数据报处理速率要求。
分组转发需要进行的处理：
- 基于目的地转发：比如汽车进入高速，服务人员根据最终目的地来决定要通向的最后一个环状交叉路的出口，并告诉驾驶员。
- 通用转发：除了目的地之外，服务人员也能基于其他许多因素确定汽车的出口闸道，比如汽车牌照所在州，汽车模型、品牌、寿命等等。
## 4.2.1 输入端口处理和基于目的地转发
![[Pasted image 20231014142751.png]] 
如果用蛮力实现转发表，那么需要对每个目的地址有一个表项，因为有超过40亿个可能的地址，这种方法总体上不可行。
现在，我们面临规模问题。一个例子，假设路由器有4条链路，分组以以下方式转发到链路接口：![[Pasted image 20231014153846.png]] 解决方法是使用==前缀（prefix）==与表中的表项进行匹配。![[Pasted image 20231014143124.png]] ==最长前缀匹配规则（longest prefix matching rule）==，也就是在表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组。
- 假设转发表已存在，看似表查找是简单那段，但是速率要极快，就需要用硬件执行查找，并且需要对大型转发表使用快速查找算法，还需要特别关注内存访问时间（需要用嵌入式片上的DRAM和更快的SRAM（用作一种DRAM缓存）内存来设计。实践中经常用==三态内容可寻址存储器（Tenary Content Address Memory，TCAM）==来查找。
一旦查找到输出端口，分组就进入交换结构。
==匹配加动作==这种抽象是用处广泛的，包括防火墙、链路层交换机、网络地址转换器（NAT）。
## 4.2.2 交换
三种交换技术：![[Pasted image 20231014154648.png]]
- 经内存交换：分组从输入端口复制到处理器内存里，然后；路由选择处理器从首部提前目的地址，在转发表里知道适当的输出端口，把分组复制到输出端口的缓存里。
	- 不能同时转发两个分组，因为一个共享系统总线一次只能允许执行一个内存的读/写。
	- 设内存读写带宽都是B个分组每秒，则转发吞吐量必然少于B/2。
- 经总线交换：不需要路由选择处理器。首先，输入端口为分组预先计划一个交换机内部标签（首部），指示本地输出端口。然后分组在总线上传送到输出端口。分组能被所有输出端口收到，只有与标签匹配的端口能保存，然后输出端口把这个标签取出。
	- 一次只有一个分组能跨越总线，所以路由器交换带宽受总线速率限制。
- 纵横式（经互联网络交换）：假设有N个输入接口和N个输出接口，则纵横式交换机是由2N条总线组成的网络，交叉点通过交换结构控制器来控制开启和闭合，通过这种手段，使某分组被转发时闭合路径上的交叉点即可。它能并行转发多个分组，因此是==非阻塞（non-blocking）==的，也就是说只要两个分组不是几乎同时到达同一个输出端口，已到达的分组就不会把刚到达的分组阻塞。
## 4.2.3 输出端口处理
![[Pasted image 20231014160252.png]] 
## 4.2.4 何时出现排队
在输入端口和输出端口都有可能形成分组队列。
随着队列增长，缓存空间耗尽且无内存可用时就会出现==丢包（packet loss）==。
设有N个输入端口和N个输出端口，输入线路和输出线路速度都是R<sub>line</sub>，交换结构传输速率是R<sub>switch</sub>如果后者比前者快N倍，那么输入端口处最多出现微不足道的排队。
### 1. 输入排队
如果R<sub>switch</sub>不够快，会出现：==线路前部（Head-Of-the-Line，HOL）阻塞==。也就是，在输入队列中排队的分组必须等待通过交换结构发送，因为它被线路前部的另一个分组阻塞。例子：![[Pasted image 20231014161744.png]] 由于HOL阻塞，输入链路上的额分组到达速率达到其容量的58%，在某些前提下，输入队列长度将无线增大。
### 2. 输出排队
R<sub>switch</sub>够快，也可能在输出端口形成排队队列。
策略：
- ==弃尾（drop-tail）==：丢弃到达的分组
- 删除一个或多个已排队的分组来腾出空间。
	- 在缓存填满之前就丢弃分组或者为分组首部加标记，可以为发送方提供拥塞信号。分组丢弃与标记策略称为==主动队列管理（Active Queue Management，AQM）==算法。其中==随机早期检测（Random Early Detection，RED）==算法最普遍。
输出端口排队的例子：![[Pasted image 20231014162414.png]] 输出端口的==分组调度（packet scheduler）==要在这些排队分组里选一个分组来传输。
确定缓存长度的经验方法：
缓存数量（B）等于平均往返时延（RTT）乘以链路的容量（C）。最近的理论是B=RTT*\C/N<sup>1/2</sup>
## 4.2.5 分组调度
一般排队规则有==先来先服务（FCFS）==，也叫先进先出（FIFO）。还有优先权、循环排队等。
### 1. 先进先出
- ==先进先出（First-In-First-Out，FIFO）==：![[Pasted image 20231014171557.png]]
### 2. 优先权排队
- ==优先权排队（priority queuing）==：到达输出链路的分组被分类放入输出队列中的优先权类。优先权类由网络操作员配置，比如携带网络管理信息的分组获得超过用户流量的优先权。实时流量分组超过非实时流量的优先权，等等。
- 传输的时候，从非空的最高优先权类中传输一个分组。同一优先权类的分组之间按照FIFO方式完成。
- 模型：![[Pasted image 20231014172215.png]]
- 在==非抢占式优先权排队（non-preemptive priority queuing）==规则下，一旦分组开始传输就不能打断。
- 例子：![[Pasted image 20231014172409.png]] （深色是两个优先权类中较高优先权类的分组）
### 3. 循环和加权公平排队
- ==循环排队规则（round robin queuing discipline）==下，分组会被分类，但不存在严格的优先权，而是循环调度器在这些类之间轮流服务。
- ==保持工作排队（work-conserving queuing）==规则在有分组排队等待传输时不允许链路保持空闲。寻找给定类的分组没有找到时就马上检查循环队列的下一个类。
- 有两个类的例子：![[Pasted image 20231014172855.png]] 
- ==加权公平排队（Weighted Fair Queuing，WFQ）==规则：![[Pasted image 20231014173328.png]]
	- 每个类被分配一个权，在任何类有分组要发送的任何时间间隔里，每个类都会确保收到的服务部分等于这个类的权占所有类的权的和的比。这样，对于一条传输速率为R的链路，每一类至少获得R\*权占全部权的比例的吞吐量。
	- 实际上，分组是离散的，不能打断一个分组的传输来传输另一个分组。这个描述不够准确。
# 4.3 网际协议：IPv4、寻址、IPv6及其他
IPv4数据报格式：
![[Pasted image 20231014174547.png]] 
- *版本（号）：这4比特规定了数据报的IP协议版本，路由器根据版本来解释IP数据报的剩余部分。
- *首部长度*：因为一个IPv4数据报首部包含可变数量的选项，所以需要4比特来确定IP数据报的载荷实际开始的地方。大多数IP数据报没有这个选项，一般IP数据报有20字节的首部。
- *服务类型（TOS）*：TOS比特在首部里，来让不同类型的IP数据报区别开来。比如，实时数据报（IP电话）和非实时流量（FTP）区分开。
- *数据报长度*：该字段16比特，因此IP数据报理论长度最大为65535字节。但是限制于以太网帧的载荷字段，IP数据报少有超过1500字节的。
- *标识、标志、片偏移*：与IP分片有关。IPv6不允许路由器对分组分片。
- *寿命（Time-To-Live，TTL）*：确保数据报不会永远在网络中循环。每经过一台路由器处理，该字段值减1，减到0就必须丢弃。
- *协议*：通常仅当IP数据报到达最终目的地才有用。该字段指示IP数据报的数据部分应该交给哪个运输层协议，6表示给TCP，17表示给UDP。
- *首部检验和*：首部每2个字节当做一个数（计算之前，检验和本身全为0），反码求和。注意，每个路由器会重新计算检验和并放到检验和字段，因为TTL等字段会变。检验到不一致就认为出错，一般丢弃。
	- 注意，IP只算首部，TCP/UDP计算整个报文段。IP与TCP/UDP不一定在同一个协议栈上，能携带不传给TCP/UDP的数据。
- *源和目的IP地址*
- *选项*：IPv6去掉了选项，因为这导致首部长度可变，还导致路由器处理IP数据报需要的时间变化很大。
- *数据（有效载荷）*：包含要交付给运输层的报文段，也可承载其他类型数据，比如ICMP报文。
IP数据报首部总长为20字节（无选项）。如果承载TCP报文，加上TCP报文的首部20字节就有总长40字节的首部。
## 4.3.2 IPv4数据报分片
链路层协议不一样，MTU可能不同。以太网帧可承载不超过1500字节，某些广域网帧可承载不超过576字节数据，链路层帧承载的最大数据量叫做==最大传送单元（Maximum Transmission Unit，MTU）==。这限制IP数据报长度。关键是，一条路径上可能每段链路使用不同的链路层协议，有不同的MTU。
所以，有时IP分组需要分片（==片：fragment==），用单独的链路层帧封装这些较小的IP数据报，来适应比它短的MTU。片到达目的地运输层之前需要重新组装。
为了保持网络核心的简单，IPv4设计者将重新组装的工作放在端系统里。
- 目的主机收到相同源的一系列数据报时，首先确定每个是否是被分过的片。
- 其次，确定何时收到最后一片。
- 最后，如何拼接到一起。
为此，IPv4设计了三个字段：
- 标识：每次发送主机发送数据报，标识号加1。分片以后，每个片的标识号相同。
- 标志 ：分片以后，最后一个片的标志比特被设为0，所有其他片的标志比特被设为1。这是为了让目的主机确信收到了最后一个片。
- 片偏移：偏移字段指定该片应该放在初始IP数据报的哪个位置，这样能让目的主机按照正确的顺序组装片，并确定是否丢失片。
- 一个例子：![[Pasted image 20231014222345.png]]
## 4.3.3 IPv4编址
- 一台主机通常只有一条链路连接到网络。主机与物理链路之间的边界叫做==接口（interface）==。路由器与任意一条链路之间的边界也叫接口。
- 一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。
- 每个IP地址长度32比特（等价4字节），因此共有2的32次方个（约40亿个）可能的IP。这些地址按照==点分十进制记法（dotted-decimal notation）==书写，也就是，每个字节用它的十进制形式书写，每个字节之间用点隔开。
- 一个例子：![[Pasted image 20231014224325.png]] 左侧三台主机和他们连接的路由器接口都有如223.1.1.xxx的IP地址，它们四个通过一个不包含路由器的网络互联起来。这个网络形成一个==子网（sub-net）==。有些地方也直接称为IP网络或者网络。IP编址为这个子网分配一个223.1.1.0/24，其中的/24记法，有时称为==子网掩码（network mask）==，子网掩码指示最左侧24比特定义了子网地址。任何其他要连到这个子网的主机都需要地址具有223.1.1.xxx的形式。
- 例如：这个图里有三个子网：![[Pasted image 20231014225512.png]]
- 子网的IP定义不局限于多台主机连到一个路由器接口的以太网端。例如，图4-20里总共6个子网：![[Pasted image 20231014225922.png]]
- 为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中的每一个都叫做一个==子网（subnet）==。
- 原则上不同的子网有完全不同的子网地址，但是实践中这些子网的子网地址通常有许多共同之处，此处需要学习编址。
- 因特网的地址分配策略被称为==无类别域间路由选择（Classless Interdomain Routing，CIDR）==，CIDR将子网寻址的概念一般化了。当使用子网寻址时，32位的IP地址被划分为两部分，也具有点分十进制数形式a.b.c.d/x，其中x指示地址的第一部分中的比特数。x最高比特构成了IP地址的网络部分，并且被称为该地址的==前缀（prefix）==或==网络前缀==。
- 一个组织通常被分配具有相同前缀的一段地址。ISP统一分配给好几个组织相同的一段地址前缀，然后告诉外界只需要把满足这个前缀的地址的数据报发来就可以了：![[Pasted image 20231014232110.png]] 然后ISP分给客户组织。
- 路由器通过最长前缀匹配，把数据转发到相应的路由。
- 如果ISP需要辅助的路由，可以这样：![[Pasted image 20231014232449.png]] 辅助的路由通告更长的前缀，这样可以利用最长前缀匹配的规则。
- 一个地址剩余32-x比特是用来区分组织内部设备的。组织内部路由器转发分组时才考虑这些比特。
- CIDR之前，IP地址网络部分被限制为8/16/24比特（A/B/C类网络），这是==分类编址（classful addressing）==。但是它们可表示的地址要么太少，对组织的设备来说不够用。要么太多，对组织来说冗余太多，利用率低下。
- IP广播地址255.255.255.255，，目的地址为这样的报文会被交付给一个字网中的所有主机，路由器也会选择性向临近子网转发这个报文（通常不这么做）
### 1. 获取一块地址
向ISP申请。
ISP是从ICANN或者授权的组织获得的地址。
### 2. 获取主机地址：动态主机配置协议
- 主机地址能手动配置，不过更多用==动态主机配置协议（Dynamic Host Configuration，DHCP）==完成。DHCP允许主机自动获取IP地址，可能是==临时IP地址（Temporary IP address）==，或者网络管理员配置DHCP给一个主机分配固定地址。DHCP还让主机能获得子网掩码、第一跳路由器地址（==默认网关==）还有本地DNS服务器地址。
- DHCP有把主机接进网络的网络方面自动能力，所以也称为==即插即用协议（plug-and-play protocol）==或==零配置（zeroconf）==协议。
- DHCP是客户-服务器协议，每个子网有一个DHCP服务器，没有就需要DHCP中继代理（一台路由器），这个代理知道用于该网络的DHCP服务器地址。![[Pasted image 20231014234117.png]] 
DHCP协议有四个步骤![[Pasted image 20231014234847.png]] 
- DHCP服务器发现：客户用UDP分组向端口67发送==DHCP发现报文==，变成的IP数据报中使用广播地址255.255.255.255，并且源IP地址为0.0.0.0。IP数据报被广播到子网的所有节点。
- DHCP服务器提供：DHCP服务器收到DHCP发现报文，用==DHCP提供报文==响应，广播到子网的所有节点，目的地址也是广播地址255.255.255.255。报文包含发现报文的事务ID、推荐的IP地址、子网掩码和==IP地址租用期==，也就是IP地址有效时间量。通常几小时或几天。
- DHCP请求：客户从一个或多个服务器中选一个，用==DHCP请求报文==响应，回显配置的参数。
- DHCP ACK：服务器用==DHCP ACK报文==对DHCP请求报文响应，证实要求的参数。
DHCP有允许客户更新IP租用的机制，让客户超时后还能使用。
## 4.3.4 网络地址转换
- 如果子网变大了，需要新一块较大的地址，有一个简单的方法：
  ==网络地址转换（Network Address Translation，NAT）==：路由器可包含NAT功能，有一个接口是==专用网络（private network）==的一部分。专用网络的地址只对网络中的设备有意义。
- NAT路由器对外界如同一个单一IP地址的单一设备。本质上讲NAT使路由器对外界隐藏了专用网络的细节。专用网络的地址是从路由器运行的DHCP服务器获得的，这个服务器为位于NAT-DHCP路由器控制的专用网络空间中的计算机提供地址。
- ![[Pasted image 20231015115246.png]] 
- ==NAT转换表（NAT translation table）==：如果对于广域网到达到NAT路由器的所有数据报都有相同的目的IP，那么这个路由器怎么知道他应将某个分组转发给哪个内部主机呢？技巧就是使用NAT路由器上的一张NAT转换表。这个表里包含了端口号以及其IP地址。
- 当报文发出的时候，源主机会配上源端口号，源端口号会被NAT路由器转换为NAT转换表里尚未存在的端口号，然后存到NAT转换表里。源主机的IP也被替换为NAT路由器的广域网侧的接口IP，然后从服务器接到报文以后，NAT路由器通过在NAT转换表里查询端口号来查到对应的IP地址和目的端口号，并替换到报文段里的正确位置，然后重写之后的数据报被转发到专用网络的对应位置。
- 端口是用来寻址进程而不是主机的。所以这种做法会引起一些问题，解决方案是用==NAT穿越==和==通用即插即用（Plug and Play，UPnP）==。
- 还有人认为，路由器是网络层设备，应当处理只能达到网络层的分组。而且NAT违反了主机应当直接彼此对话这个原则。
- 不过，NAT已经成为所谓的==中间盒==的一部分。中间盒不执行数据包转发，而是进行NAT、流量负载均衡、防火墙等功能。
	- 防火墙：安装在路由器里，检查数据报和报文段首部，拒绝可疑数据报进入内部网络。
		- 例如，配置为阻挡ICMP回显请求分组，就能防止进行传统端口扫描。
		- 防火墙还能跟踪TCP连接，仅允许批准连接的数据报进入。
	- 入侵检测系统（IDS）：执行深度分组检查，不仅检查数据报和报文首部，而且检查有效载荷，与特征数据库匹配来发现攻击。
	- 入侵防止系统（IPS）：比IDS多了一个实际阻挡分组的功能。
## 4.3.5 IPv6
由于面临32比特的IP地址空间即将用尽，上世纪90年代早期就开始开发IPv6。
### 1. IPv6 数据报格式
![[Pasted image 20231015144512.png]] 
IPv6的变化：
- *扩大的地址容量*：从32比特到128比特。除了单播和多播地址以外，IPv6还引入了一种称为==任播地址（anycast address）==的新型地址，使数据报可能交付给一组主机中的任意一个（比如向一组包含给定文档的镜像站点的最近一个发送HTTP GAT报文）
- *简化高效的40字节首部*：定长，新的选项编码来允许更灵活的选项处理。
- *流标签*：==流（flow）==用于给属于特殊流的分组加上标签，这些特殊流是发送方要求进行特殊处理的流，如一种非默认服务质量或需要实时服务的流。比如，音视频传输、文件传输、电子邮件就不能被当成流，高优先权用户承载的流量可能被当做流。
IPv6的字段：
- *版本*：版本号，IPv6设为6。
- *流量类型*：与TOS字段含义相似。
- *流标签*：20比特，能够给某些数据报优先权（比如IP语音高于SMTP）。
- *有效载荷长度*：16比特，无符号整数，指出在定长的40字节数据报首部之后的字节数量。
- *下一个首部*：表示数据报的数据字段需要交付给哪个协议（TCP/UDP），6表示给TCP，17表示给UDP。其实与IPv4的协议字段相同。
- *跳限制*：每台路由器对该字段减1，为0则丢弃。
- *源地址和目的地址*
- *数据*：数据报的有效载荷部分。
比IPv4少的字段：
- 分片/重新组装：IPv6不允许路由器分片重组，只能在源或目的端执行。如果路由器收到的数据包太大不能转发到链路上，直接丢，然后向发送方发回一个“分组太大”的ICMP差错报文即可。这大大加快了网络中IP转发速度。
- 首部检验和：因为运输层和数据链路层协议执行了检验操作，IP设计者觉得多余，于是删掉了。计算检验和是耗时的。
- 选项：不是标准IP首部的一部分，但是还没消失，而是可能出现在“下一个首部”指出的位置上。这就是说，如同TCP或UDP协议首部能是IP分组的“下一个首部”一样，选项字段也能是“下一个首部”。
### 2. 从IPv4到IPv6的迁移：
基于IPv6的因特网能向后兼容IPv4，但是已部署的IPv4系统不能处理IPv6数据报。
- 愚蠢的方法：宣布一个标志日，让所有因特网机器关机，从IPv4升级到IPv6.
- 实践中迁移方法：==建隧道==。
	- 建隧道的基本思想是：假定两个IPv6节点，中间通过IPv4路由器互联，这个集合称为一个隧道，在隧道的端发送的IPv6数据报可以放到IPv4数据报有效载荷里，IPv4协议号字段设为41，接收端通过协议号来取出IPv6数据报。![[Pasted image 20231015152654.png]] 
# 4.4 通用转发和SDN
中间盒过多，很麻烦。
考虑“匹配加动作”范式：
- 匹配：对协议栈的多个首部字段进行匹配
- 动作：将分组转发到输出端口、在离开接口进行负载均衡分组、重写首部值（NAT）、有意识阻挡/丢弃分组（防火墙）、为了进一步处理向特定服务器发送分组（DPI）。
在通用转发中，一张匹配加动作表就将基于目的地的转发表一般化了。因为能使用网络层或链路层源和目的地址作出转发决定，所以叫图里的转发设备叫“分组交换机”：![[Pasted image 20231015155906.png]] 分组交换机的匹配加动作表由远程控制器计算和分发。
后续基于OpenFlow来讨论通用转发：
- 流表：匹配加动作转发表。实践中一个流表可用多个流表实现，但是在这里只关注单一流表的抽象。
	- 首部字段值集合：入分组与其匹配。基于硬件匹配在TCAM内存执行的最快。匹配不上的分组就会被丢弃或者发到远程控制器做更多处理。
	- 计数器集合：当分组与流表项匹配时更新计数器。计数器可以包括已经与该表项匹配的分组数量，以及自从该表项上次更新以来的时间。
	- 动作集合：分组匹配流表项时采取的动作集合。可能是转发，可能是丢弃，可能是复制分组，重写首部字段，等等。
## 4.4.1 匹配
OpenFlow匹配抽象允许对三个层次（链路层、网络层、运输层）报文段进行匹配。![[Pasted image 20231015161939.png]] 入端口是分组交换机上接收分组的输入端口。流表项也有通配符，比如IP128.119.\*.\*，就匹配其前16比特为128.119的任何数据报所对应的地址字段。流表项还有优先级，一个分组匹配多个刘表项，选定的匹配是优先级最高的那个。
不是IP首部的所有字段都能被匹配。
## 4.4.2 动作
- 转发：入分组可以转发到特定输出端口或输出端口集合或除分组到达的端口以外的所有端口。可能被封装并发到远程控制器，远程控制器可能安装新的流表项，然后把分组返回该原设备在更新的流表规则下进行转发。
- 丢弃：匹配到没有动作的流表项的分组被丢弃。
- 修改字段：首部10个字段（图4-29里除了IP协议之外的字段）可以重写。
## 4.4.3 匹配加动作操作中的OpenFlow例子
见：[[计算机网络：自顶向下方法（原书第七版）.pdf#page=252&selection=109,1,114,2|计算机网络：自顶向下方法（原书第七版）, page 252]] 
# 4.5 小结
略。